<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Financial Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for the Dashboard Timeline -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // setLogLevel is available but kept commented out for cleaner console

        // IMPORTANT: Global variables must be defined before use
        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        let isPersistentMode = false; // Flag to track persistence state
        let chartInstance = null; // Global instance for Chart.js

        // Make functions available globally for HTML event handlers
        window.saveContribution = saveContribution;
        window.onMonthChange = onMonthChange; 

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Constants
        const START_DATE_STRING = '2025-04-21';
        const DAILY_CONTRIBUTION_DEFAULT = 50;
        const COLLECTION_PATH = `artifacts/${appId}/users/`;

        // Cache for all contributions (used in persistent mode)
        let contributionData = {}; 
        let fullHistoryData = []; // Cache for calculated history
        let monthsAvailable = []; // Cache for available months/years

        // Utility functions
        const formatDate = (date) => {
            const d = new Date(date);
            let day = d.getDate();
            let month = d.getMonth() + 1;
            const year = d.getFullYear();
            if (day < 10) day = '0' + day;
            if (month < 10) month = '0' + month;
            return `${day}/${month}/${year}`;
        };
        
        const dateToKey = (date) => {
            const d = new Date(date);
            let month = d.getMonth() + 1;
            let day = d.getDate();
            const year = d.getFullYear();
            if (day < 10) day = '0' + day;
            if (month < 10) month = '0' + month;
            return `${year}-${month}-${day}`;
        };

        // --- FIREBASE INIT/AUTH LOGIC ---

        async function initFirebase() {
            const statusElement = document.getElementById('statusMessage');
            
            if (Object.keys(firebaseConfig).length === 0) {
                statusElement.textContent = "Persistence DISABLED (Config Missing)";
                statusElement.classList.replace('text-blue-600', 'text-red-600');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isPersistentMode = true; // Enable persistence flag
                statusElement.textContent = "Authenticating...";

                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); 
                        if (user) {
                            userId = user.uid;
                            isAuthReady = true;
                            document.getElementById('userIdDisplay').textContent = userId;
                            statusElement.textContent = "Persistent Mode Ready";
                            statusElement.classList.replace('text-blue-600', 'text-green-600');
                            setupSnapshotListener(); 
                            resolve();
                        } else {
                             try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("Firebase Auth failed:", error);
                                statusElement.textContent = "Auth Failed";
                                statusElement.classList.replace('text-blue-600', 'text-red-600');
                                isPersistentMode = false;
                                resolve(); 
                            }
                        }
                    });
                });
            } catch (error) {
                console.error("Initialization error:", error);
                statusElement.textContent = "Persistence DISABLED (Init Error)";
                statusElement.classList.replace('text-blue-600', 'text-red-600');
                isPersistentMode = false;
            }
        }

        function setupSnapshotListener() {
            if (!isAuthReady || !userId || !isPersistentMode) return;

            const contributionsRef = collection(db, COLLECTION_PATH + userId + "/contributions");
            const q = query(contributionsRef); 

            onSnapshot(q, (snapshot) => {
                let tempCache = {};
                snapshot.forEach((doc) => {
                    tempCache[doc.id] = doc.data();
                });
                contributionData = tempCache;
                // Data loaded successfully from Firestore, now update the UI
                updateUI(); 
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                document.getElementById('statusMessage').textContent = "Data Fetch Error";
                document.getElementById('statusMessage').classList.replace('text-green-600', 'text-red-600');
            });
        }

        async function saveContribution(dateKey, amountInput, remarkInput, purchaseInput, purchaseAmountInput) {
            
            const newAmount = parseFloat(amountInput.value) || 0;
            const newRemark = remarkInput.value.trim();
            const newPurchase = purchaseInput.value.trim();
            const newPurchaseAmount = parseFloat(purchaseAmountInput.value) || 0;
            
            // 1. Local update for immediate UI feedback (before potential Firestore refresh)
            contributionData[dateKey] = {
                amount: newAmount,
                remark: newRemark,
                purchase: newPurchase,
                purchaseAmount: newPurchaseAmount
            };
            // Get current month selection before re-rendering
            const currentMonthKey = document.getElementById('monthSelector')?.value;
            updateUI(currentMonthKey); 

            // 2. Attempt to save remotely only if persistence is ready
            if (!isPersistentMode || !isAuthReady || !userId || !db) {
                const saveError = document.getElementById('saveError');
                saveError.textContent = `Cannot save: Persistence is disabled. Changes are temporary until refresh.`;
                saveError.classList.remove('hidden');
                setTimeout(() => saveError.classList.add('hidden'), 3000);
                return;
            }

            if (isNaN(newAmount) || newAmount < 0 || isNaN(newPurchaseAmount) || newPurchaseAmount < 0) {
                console.warn("Invalid number entered.");
                return;
            }

            const contributionDocRef = doc(db, COLLECTION_PATH + userId + "/contributions", dateKey);

            try {
                await setDoc(contributionDocRef, {
                    date: dateKey,
                    amount: newAmount,
                    remark: newRemark || 'User-defined contribution',
                    purchase: newPurchase || '',
                    purchaseAmount: newPurchaseAmount || 0,
                });
                
                // Visual feedback on success
                amountInput.classList.add('border-green-500', 'ring-1', 'ring-green-500');
                setTimeout(() => {
                    amountInput.classList.remove('border-green-500', 'ring-1', 'ring-green-500');
                }, 1000);

            } catch (error) {
                console.error("Error saving contribution:", error);
                // Visual feedback on error
                amountInput.classList.add('border-red-500', 'ring-1', 'ring-red-500');
            }
        }

        // --- UI RENDERING / DATA CALCULATION LOGIC ---

        function calculateAndPrepareData() {
            const startDate = new Date(START_DATE_STRING);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let cumulativeTotal = 0;
            let totalDays = 0;
            
            fullHistoryData = [];
            monthsAvailable = [];
            let monthKeysSet = new Set();
            
            let currentDate = new Date(startDate);
            
            while (currentDate <= today) {
                const dateKey = dateToKey(currentDate);
                const dayOfWeek = currentDate.getDay(); // 0 is Sunday, 5 is Friday
                const isFriday = dayOfWeek === 5;
                
                const monthKey = dateKey.substring(0, 7); // YYYY-MM
                if (!monthKeysSet.has(monthKey)) {
                    monthKeysSet.add(monthKey);
                    monthsAvailable.push({ key: monthKey, label: new Date(monthKey + '-01').toLocaleString('default', { month: 'long', year: 'numeric' }) });
                }
                
                // --- Default Values ---
                let amount = DAILY_CONTRIBUTION_DEFAULT;
                let remark = 'Standard Contribution';
                let purchase = '';
                let purchaseAmount = 0;

                // Apply Friday rule
                if (isFriday) {
                    amount = 0;
                    remark = 'Off Day (Automated)';
                }

                // --- Load Saved/Cached Data ---
                if (contributionData[dateKey] !== undefined) {
                    const saved = contributionData[dateKey];
                    // Using nullish coalescing to ensure defaults are kept if fields are missing in saved data
                    amount = saved.amount ?? amount;
                    remark = saved.remark ?? remark;
                    purchase = saved.purchase ?? purchase;
                    purchaseAmount = saved.purchaseAmount ?? purchaseAmount;
                }
                
                // Update running totals
                cumulativeTotal += amount;
                cumulativeTotal -= purchaseAmount; 
                totalDays++;
                
                // Save the full history point
                fullHistoryData.push({
                    dateKey,
                    dateDisplay: formatDate(currentDate),
                    isFriday,
                    amount: amount,
                    remark: remark,
                    purchase: purchase,
                    purchaseAmount: purchaseAmount,
                    cumulativeTotal: cumulativeTotal,
                    monthKey: monthKey,
                });

                // Move to the next day
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return { 
                totalDays, 
                finalTotal: cumulativeTotal, 
                history: fullHistoryData,
                months: monthsAvailable
            };
        }

        function updateUI(filterMonthKey = null) {
            const { totalDays, finalTotal, history, months } = calculateAndPrepareData();
            
            // 1. Update Summary Cards
            document.getElementById('daysCountDisplay').textContent = totalDays;
            document.getElementById('totalContributionDisplay').textContent = finalTotal.toFixed(2);
            
            // 2. Populate Month Selector 
            const monthSelector = document.getElementById('monthSelector');
            if (monthSelector.options.length === 0 || months.length !== monthSelector.options.length) {
                monthSelector.innerHTML = '';
                months.reverse().forEach(month => { // Show newest months first
                    const option = document.createElement('option');
                    option.value = month.key;
                    option.textContent = month.label;
                    monthSelector.appendChild(option);
                });
            }
            
            // Set the month key filter, prioritizing the provided key, then the current selection, then the latest month
            if (!filterMonthKey) {
                filterMonthKey = monthSelector.value || months[0]?.key;
            }

            // Ensure selector is set to the determined key
            if(filterMonthKey) monthSelector.value = filterMonthKey;


            // 3. Render Table (Monthly View)
            renderTable(history, filterMonthKey);

            // 4. Render Chart (Full History View)
            renderChart(history);
        }

        function onMonthChange(selectElement) {
            updateUI(selectElement.value);
        }

        function renderTable(history, filterMonthKey) {
            const dataBody = document.getElementById('dataBody');
            dataBody.innerHTML = ''; 
            const isReadonly = !isPersistentMode;

            // Filter data to show only the selected month
            const filteredHistory = history.filter(day => day.monthKey === filterMonthKey);
            
            if (filteredHistory.length === 0) {
                dataBody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No data available for this month.</td></tr>';
                return;
            }

            filteredHistory.forEach(day => {
                const { dateKey, dateDisplay, isFriday, amount, remark, purchase, purchaseAmount, cumulativeTotal } = day;
                
                // --- UI Rendering ---
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // Helper to create input with class
                const createInput = (type, value, placeholder, isSmall = false) => {
                    const input = document.createElement('input');
                    input.type = type;
                    input.value = (type === 'number') ? amount.toFixed(2) : value; // Ensure number format on load
                    input.placeholder = placeholder;
                    // Note: Inputs are always editable on the UI for quick updates, but saving depends on isPersistentMode
                    input.className = 'w-full text-center border rounded-md p-1 focus:ring-blue-500 focus:border-blue-500 ' + 
                                      (isSmall ? 'text-xs' : 'text-sm font-mono') + (!isPersistentMode ? ' bg-gray-100/50' : '');
                    return input;
                };

                // Helper to create and append table cell
                const createCell = (content, className = '') => {
                    const cell = document.createElement('td');
                    cell.className = `px-3 py-1 whitespace-nowrap text-sm text-gray-900 ${className}`;
                    if (typeof content === 'string') {
                        cell.textContent = content;
                    } else {
                        cell.appendChild(content);
                    }
                    row.appendChild(cell);
                    return cell;
                };


                // A. Date Cell
                const dateCell = createCell(dateDisplay);
                if (isFriday) {
                    dateCell.classList.add('bg-yellow-100/50', 'font-semibold');
                    dateCell.textContent += ' (Fri)';
                }

                // B. Contribution Input
                const amountInput = createInput('number', amount, '50.00');
                amountInput.min = '0';
                amountInput.step = '1';
                const amountCell = createCell(amountInput, 'text-right w-1/12');
                if (amount === 0 && isFriday) amountCell.classList.add('bg-yellow-50');

                // C. Remark Input
                const remarkInput = createInput('text', remark, 'Add contribution remark', true);
                createCell(remarkInput, 'text-left w-2/12');
                
                // D. Purchase Item Input
                const purchaseInput = createInput('text', purchase, 'e.g., New Gadget', true);
                createCell(purchaseInput, 'text-left w-2/12');
                
                // E. Purchase Amount Input
                const purchaseAmountInput = createInput('number', purchaseAmount, '0.00');
                purchaseAmountInput.min = '0';
                purchaseAmountInput.step = '1';
                const purchaseAmountCell = createCell(purchaseAmountInput, 'text-right w-1/12');
                if (purchaseAmount > 0) purchaseAmountCell.classList.add('bg-red-50');

                // F. Cumulative Subtotal Cell
                createCell(cumulativeTotal.toFixed(2), 'text-green-700 font-extrabold text-right w-1/12 bg-green-50');

                // Set event listeners to save on blur 
                const inputs = [amountInput, remarkInput, purchaseInput, purchaseAmountInput];
                inputs.forEach(input => {
                    input.onblur = () => saveContribution(dateKey, amountInput, remarkInput, purchaseInput, purchaseAmountInput);
                });

                // Highlight today's row if visible
                const todayKey = dateToKey(new Date());
                if (dateKey === todayKey) {
                    row.classList.add('total-row', 'border-4', 'border-green-300'); // Highlight today
                    row.querySelector('td:first-child').textContent += ' (Today)';
                }

                dataBody.appendChild(row);
            });
        }

        function renderChart(history) {
            const chartCanvas = document.getElementById('cumulativeChart');
            if (!chartCanvas) return;

            // Prepare data for Chart.js
            // Chart shows ALL history, not just the filtered month
            const chartLabels = history.map(d => d.dateDisplay.substring(0, d.dateDisplay.length - 5)); // Remove year
            const chartDataPoints = history.map(d => d.cumulativeTotal);

            const data = {
                labels: chartLabels,
                datasets: [{
                    label: 'Net Cumulative Total (RM)',
                    data: chartDataPoints,
                    fill: true,
                    borderColor: 'rgb(52, 211, 153)', // Tailwind green-400
                    backgroundColor: 'rgba(52, 211, 153, 0.2)',
                    tension: 0.2, // Make the line smoother
                    pointRadius: 0 // Hide individual points
                }]
            };

            const config = {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Net Cumulative Total Over Time', font: { size: 14 } }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Date' },
                            ticks: {
                                autoSkip: true,
                                maxTicksLimit: 10, // Limit ticks to avoid clutter
                                maxRotation: 0,
                                minRotation: 0,
                                // Show only a few ticks on the x-axis
                                callback: function(val, index) {
                                    // Show a tick label roughly every N days for clean look
                                    const N = Math.ceil(chartLabels.length / 8);
                                    return (index % N) === 0 ? this.getLabelForValue(val) : '';
                                }
                            }
                        },
                        y: {
                            title: { display: true, text: 'Amount (RM)' },
                            beginAtZero: true
                        }
                    }
                }
            };

            if (chartInstance) {
                chartInstance.data = data;
                chartInstance.update();
            } else {
                chartInstance = new Chart(chartCanvas, config);
            }
        }

        // --- INITIALIZATION LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. GUARANTEED initial render: Display calculated data immediately
            updateUI(); 
            // 2. Then, start the asynchronous Firebase setup
            initFirebase();
        });
        // --- END INITIALIZATION LOGIC ---
    </script>
    <style>
        /* Custom styles for professional, spreadsheet look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .container {
            max-width: 1200px; /* Wider container for 6 columns */
            margin: 2rem auto;
            padding: 20px;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border-radius: 12px;
        }
        .header-cell {
            background-color: #e5e7eb; /* Light gray for headers */
            font-weight: 600;
        }
        .total-row {
            background-color: #d1fae5; /* Light green for the total row */
            font-weight: 700;
            font-size: 1.125rem;
        }
        /* Ensure inputs look good */
        input[type="text"], input[type="number"] {
            padding: 0.25rem 0.5rem;
            height: 2rem;
            min-width: 0; /* Allow inputs to shrink */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Dynamic Contribution & Spending Tracker</h1>
        <p class="text-gray-500 mb-2">Editable tracker starting from April 21st, 2025. Fridays default to RM0.</p>
        
        <div class="text-sm mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden" id="saveError">
            ⚠️ **Saving Disabled:** Persistence is not active. Changes are temporary.
        </div>

        <div class="text-sm text-gray-500 mb-6 flex justify-between items-center">
            <span>
                User ID: <span id="userIdDisplay" class="font-mono text-xs bg-gray-100 p-1 rounded">N/A</span> 
            </span>
            <span>
                Status: <span id="statusMessage" class="font-medium text-blue-600">Initializing...</span>
            </span>
        </div>

        <!-- Summary Statistics Card and Chart -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <!-- 1. CHART CONTAINER (Replacing Start Date Card) -->
            <div class="md:col-span-2 bg-white p-4 rounded-lg shadow border border-gray-100 h-80">
                <div class="h-full w-full">
                    <canvas id="cumulativeChart"></canvas>
                </div>
            </div>

            <!-- 2. SUMMARY STATS -->
            <div class="flex flex-col space-y-4">
                <div class="bg-purple-50 p-4 rounded-lg shadow">
                    <p class="text-sm font-medium text-purple-600">Days Tracked</p>
                    <p id="daysCountDisplay" class="text-2xl font-semibold text-purple-800">...</p>
                </div>
                <div class="bg-green-500 p-4 rounded-lg shadow flex-grow">
                    <p class="text-sm font-medium text-white">NET CUMULATIVE TOTAL (RM)</p>
                    <p id="totalContributionDisplay" class="text-4xl font-extrabold text-white">...</p>
                </div>
            </div>
        </div>
        
        <!-- MONTHLY FILTER AND TABLE -->
        <div class="mb-4 flex items-center space-x-3">
            <label for="monthSelector" class="text-sm font-medium text-gray-700">View Month:</label>
            <select id="monthSelector" onchange="onMonthChange(this)" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <!-- Options populated by JavaScript -->
            </select>
        </div>


        <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-3 py-3 text-left text-xs text-gray-700 uppercase tracking-wider header-cell rounded-tl-lg w-1/12">
                            Date
                        </th>
                        <th class="px-3 py-3 text-center text-xs text-gray-700 uppercase tracking-wider header-cell w-1/12">
                            Contribution (RM) 
                        </th>
                        <th class="px-3 py-3 text-left text-xs text-gray-700 uppercase tracking-wider header-cell w-2/12">
                            Remark
                        </th>
                        <th class="px-3 py-3 text-left text-xs text-gray-700 uppercase tracking-wider header-cell w-2/12">
                            Purchase Item
                        </th>
                        <th class="px-3 py-3 text-center text-xs text-gray-700 uppercase tracking-wider header-cell w-1/12">
                            Purchase Amount (RM)
                        </th>
                        <th class="px-3 py-3 text-right text-xs text-gray-700 uppercase tracking-wider header-cell rounded-tr-lg w-1/12">
                            Net Cumulative (RM)
                        </th>
                    </tr>
                </thead>
                <tbody id="dataBody" class="bg-white divide-y divide-gray-100">
                    <!-- Data rows will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
        <p class="mt-4 text-sm text-gray-500">Edit any cell to update the tracker. If persistence is active, changes are automatically saved.</p>
    </div>
</body>
</html>
